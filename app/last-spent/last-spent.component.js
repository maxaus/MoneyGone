"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var spent_item_service_1 = require("../shared/spent-item.service");
var nativescript_angular_1 = require("nativescript-angular");
var dialogs_1 = require("ui/dialogs");
var moment = require("moment");
var LastSpentComponent = (function () {
    function LastSpentComponent(spentItemService, routerExtensions, pageRoute) {
        var _this = this;
        this.spentItemService = spentItemService;
        this.routerExtensions = routerExtensions;
        this.pageRoute = pageRoute;
        this.items = [];
        this.sortCol = 'dateAdded';
        this.sortDir = 'DESC';
        this.currentDate = new Date();
        this.totalSum = 0;
        this.excludedSum = 0;
        this.deleteConfirmOptions = {
            title: "Confirm Delete",
            message: "Do you really want to remove this item?",
            okButtonText: "Yes",
            cancelButtonText: "No"
        };
        this.sortOptions = {
            title: "Sort By",
            message: "Choose sort direction",
            cancelButtonText: "Cancel",
            actions: ["Recent first", "Old first", "Expensive first", "Cheap first"]
        };
        this.pageRoute.activatedRoute
            .switchMap(function (activatedRoute) { return activatedRoute.params; })
            .forEach(function (params) {
            var year = +params["year"];
            var month = +params["month"];
            _this.startDate = moment(year + '-' + month + '-01').startOf('month').toDate();
            _this.endDate = moment(year + '-' + month + '-01').endOf('month').toDate();
            var currentMoment = moment(_this.startDate);
            _this.displayNextMonth = currentMoment.year() < _this.currentDate.getFullYear() ||
                (_this.currentDate.getFullYear() == currentMoment.year() && currentMoment.month() < _this.currentDate.getMonth());
        });
    }
    LastSpentComponent.prototype.ngOnInit = function () {
        console.log('init');
        this._loadItems();
    };
    LastSpentComponent.prototype._loadItems = function () {
        var _this = this;
        this.monthLabel = moment(this.startDate).format('MMM, YYYY');
        this.spentItemService.getByDateRange(this.startDate, this.endDate, this.sortCol, this.sortDir)
            .then(function (items) {
            console.log(JSON.stringify(items));
            _this.items = items;
            _this.totalSum = (!!items && items.length) ? items.map(function (item) { return item.excludeFromSum ? 0 : item.sum; }).reduce(function (sum, x) { return sum + x; }) : 0;
            _this.excludedSum = (!!items && items.length) ? items.map(function (item) { return item.excludeFromSum ? item.sum : 0; }).reduce(function (sum, x) { return sum + x; }) : 0;
        });
    };
    LastSpentComponent.prototype.showPrevMonth = function () {
        this.startDate = moment(this.startDate).subtract(1, 'month').startOf('month').toDate();
        this.endDate = moment(this.endDate).subtract(1, 'month').endOf('month').toDate();
        var currentMoment = moment(this.startDate);
        console.log(JSON.stringify(this.currentDate.getFullYear()), JSON.stringify(currentMoment.year()));
        console.log(JSON.stringify(this.currentDate.getMonth()), JSON.stringify(currentMoment.month()));
        this.displayNextMonth = currentMoment.year() < this.currentDate.getFullYear() ||
            (this.currentDate.getFullYear() == currentMoment.year() && currentMoment.month() < this.currentDate.getMonth());
        this._loadItems();
    };
    LastSpentComponent.prototype.showNextMonth = function () {
        this.startDate = moment(this.startDate).add(1, 'month').startOf('month').toDate();
        this.endDate = moment(this.endDate).add(1, 'month').endOf('month').toDate();
        var currentMoment = moment(this.startDate);
        this.displayNextMonth = currentMoment.year() < this.currentDate.getFullYear() ||
            (this.currentDate.getFullYear() == currentMoment.year() && currentMoment.month() < this.currentDate.getMonth());
        this._loadItems();
    };
    LastSpentComponent.prototype.editItem = function (id) {
        console.log('Open edit form for item with ID:' + id);
        this.routerExtensions.navigate(["/spent-form", id], {});
    };
    LastSpentComponent.prototype.deleteItem = function (id) {
        var _this = this;
        dialogs_1.confirm(this.deleteConfirmOptions).then(function (result) {
            if (result) {
                _this.spentItemService.delete(id)
                    .then(function () {
                    _this._loadItems();
                });
            }
        });
    };
    LastSpentComponent.prototype._getSortExp = function (option) {
        switch (option) {
            case 'New first':
                return ['dateAdded', 'DESC'];
            case 'Old first':
                return ['dateAdded', 'ASC'];
            case 'Expensive first':
                return ['sum', 'Desc'];
            case 'Cheap first':
                return ['sum', 'ASC'];
            default:
                return ['dateAdded', 'DESC'];
        }
    };
    LastSpentComponent.prototype.openSortDialog = function () {
        var _this = this;
        dialogs_1.action(this.sortOptions).then(function (result) {
            var sortExpressionParts = _this._getSortExp(result);
            _this.sortCol = sortExpressionParts[0];
            _this.sortDir = sortExpressionParts[1];
            _this._loadItems();
        });
    };
    LastSpentComponent.prototype.onSearchLayoutLoaded = function (event) {
        if (event.object.android) {
            event.object.android.setFocusableInTouchMode(true);
        }
    };
    LastSpentComponent.prototype.onSearchBarLoaded = function (event) {
        if (event.object.android) {
            event.object.android.clearFocus();
        }
    };
    LastSpentComponent = __decorate([
        core_1.Component({
            selector: "app-last-spent",
            moduleId: module.id,
            templateUrl: "./last-spent.component.html",
            styleUrls: ["./last-spent.component.css"],
        }),
        __metadata("design:paramtypes", [spent_item_service_1.SpentItemService, nativescript_angular_1.RouterExtensions, nativescript_angular_1.PageRoute])
    ], LastSpentComponent);
    return LastSpentComponent;
}());
exports.LastSpentComponent = LastSpentComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFzdC1zcGVudC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsYXN0LXNwZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUFnRDtBQUNoRCxtRUFBOEQ7QUFDOUQsNkRBQWlFO0FBQ2pFLHNDQUEyQztBQUMzQywrQkFBaUM7QUFRakM7SUF5QkksNEJBQW9CLGdCQUFrQyxFQUFVLGdCQUFrQyxFQUFVLFNBQW9CO1FBQWhJLGlCQWFDO1FBYm1CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFBVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBVztRQXZCekgsVUFBSyxHQUFHLEVBQUUsQ0FBQztRQUtWLFlBQU8sR0FBRyxXQUFXLENBQUM7UUFDdEIsWUFBTyxHQUFHLE1BQU0sQ0FBQztRQUNqQixnQkFBVyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDMUIsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLGdCQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ2YseUJBQW9CLEdBQUc7WUFDM0IsS0FBSyxFQUFFLGdCQUFnQjtZQUN2QixPQUFPLEVBQUUseUNBQXlDO1lBQ2xELFlBQVksRUFBRSxLQUFLO1lBQ25CLGdCQUFnQixFQUFFLElBQUk7U0FDekIsQ0FBQztRQUNNLGdCQUFXLEdBQUc7WUFDbEIsS0FBSyxFQUFFLFNBQVM7WUFDaEIsT0FBTyxFQUFFLHVCQUF1QjtZQUNoQyxnQkFBZ0IsRUFBRSxRQUFRO1lBQzFCLE9BQU8sRUFBRSxDQUFDLGNBQWMsRUFBRSxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsYUFBYSxDQUFDO1NBQzNFLENBQUM7UUFHRSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWM7YUFDeEIsU0FBUyxDQUFDLFVBQUEsY0FBYyxJQUFJLE9BQUEsY0FBYyxDQUFDLE1BQU0sRUFBckIsQ0FBcUIsQ0FBQzthQUNsRCxPQUFPLENBQUMsVUFBQyxN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QUFDO0lBQ0wsQ0FBQztJQUVELDhDQUFpQixHQUFqQixVQUFrQixLQUFLO1FBQ25CLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUN2QixLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUN0QyxDQUFDO0lBQ0wsQ0FBQztJQTdIUSxrQkFBa0I7UUFOOUIsZ0JBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxnQkFBZ0I7WUFDMUIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ25CLFdBQVcsRUFBRSw2QkFBNkI7WUFDMUMsU0FBUyxFQUFFLENBQUMsNEJBQTRCLENBQUM7U0FDNUMsQ0FBQzt5Q0EwQndDLHFDQUFnQixFQUE0Qix1Q0FBZ0IsRUFBcUIsZ0NBQVM7T0F6QnZILGtCQUFrQixDQThIOUI7SUFBRCx5QkFBQztDQUFBLEFBOUhELElBOEhDO0FBOUhZLGdEQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBPbkluaXR9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7U3BlbnRJdGVtU2VydmljZX0gZnJvbSBcIi4uL3NoYXJlZC9zcGVudC1pdGVtLnNlcnZpY2VcIjtcclxuaW1wb3J0IHtQYWdlUm91dGUsIFJvdXRlckV4dGVuc2lvbnN9IGZyb20gXCJuYXRpdmVzY3JpcHQtYW5ndWxhclwiO1xyXG5pbXBvcnQge2FjdGlvbiwgY29uZmlybX0gZnJvbSBcInVpL2RpYWxvZ3NcIjtcclxuaW1wb3J0ICogYXMgbW9tZW50IGZyb20gJ21vbWVudCc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiBcImFwcC1sYXN0LXNwZW50XCIsXHJcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxyXG4gICAgdGVtcGxhdGVVcmw6IFwiLi9sYXN0LXNwZW50LmNvbXBvbmVudC5odG1sXCIsXHJcbiAgICBzdHlsZVVybHM6IFtcIi4vbGFzdC1zcGVudC5jb21wb25lbnQuY3NzXCJdLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgTGFzdFNwZW50Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgICBwdWJsaWMgaXRlbXMgPSBbXTtcclxuICAgIHB1YmxpYyBtb250aExhYmVsOiBzdHJpbmc7XHJcbiAgICBwdWJsaWMgZGlzcGxheU5leHRNb250aDogYm9vbGVhbjtcclxuICAgIHByaXZhdGUgc3RhcnREYXRlOiBEYXRlO1xyXG4gICAgcHJpdmF0ZSBlbmREYXRlOiBEYXRlO1xyXG4gICAgcHJpdmF0ZSBzb3J0Q29sID0gJ2RhdGVBZGRlZCc7XHJcbiAgICBwcml2YXRlIHNvcnREaXIgPSAnREVTQyc7XHJcbiAgICBwcml2YXRlIGN1cnJlbnREYXRlID0gbmV3IERhdGUoKTtcclxuICAgIHB1YmxpYyB0b3RhbFN1bSA9IDA7XHJcbiAgICBwdWJsaWMgZXhjbHVkZWRTdW0gPSAwO1xyXG4gICAgcHJpdmF0ZSBkZWxldGVDb25maXJtT3B0aW9ucyA9IHtcclxuICAgICAgICB0aXRsZTogXCJDb25maXJtIERlbGV0ZVwiLFxyXG4gICAgICAgIG1lc3NhZ2U6IFwiRG8geW91IHJlYWxseSB3YW50IHRvIHJlbW92ZSB0aGlzIGl0ZW0/XCIsXHJcbiAgICAgICAgb2tCdXR0b25UZXh0OiBcIlllc1wiLFxyXG4gICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6IFwiTm9cIlxyXG4gICAgfTtcclxuICAgIHByaXZhdGUgc29ydE9wdGlvbnMgPSB7XHJcbiAgICAgICAgdGl0bGU6IFwiU29ydCBCeVwiLFxyXG4gICAgICAgIG1lc3NhZ2U6IFwiQ2hvb3NlIHNvcnQgZGlyZWN0aW9uXCIsXHJcbiAgICAgICAgY2FuY2VsQnV0dG9uVGV4dDogXCJDYW5jZWxcIixcclxuICAgICAgICBhY3Rpb25zOiBbXCJSZWNlbnQgZmlyc3RcIiwgXCJPbGQgZmlyc3RcIiwgXCJFeHBlbnNpdmUgZmlyc3RcIiwgXCJDaGVhcCBmaXJzdFwiXVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHNwZW50SXRlbVNlcnZpY2U6IFNwZW50SXRlbVNlcnZpY2UsIHByaXZhdGUgcm91dGVyRXh0ZW5zaW9uczogUm91dGVyRXh0ZW5zaW9ucywgcHJpdmF0ZSBwYWdlUm91dGU6IFBhZ2VSb3V0ZSkge1xyXG4gICAgICAgIHRoaXMucGFnZVJvdXRlLmFjdGl2YXRlZFJvdXRlXHJcbiAgICAgICAgICAgIC5zd2l0Y2hNYXAoYWN0aXZhdGVkUm91dGUgPT4gYWN0aXZhdGVkUm91dGUucGFyYW1zKVxyXG4gICAgICAgICAgICAuZm9yRWFjaCgocGFyYW1zKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgeWVhciA9ICtwYXJhbXNbXCJ5ZWFyXCJdO1xyXG4gICAgICAgICAgICAgICAgbGV0IG1vbnRoID0gK3BhcmFtc1tcIm1vbnRoXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnREYXRlID0gbW9tZW50KHllYXIgKyAnLScgKyBtb250aCArICctMDEnKS5zdGFydE9mKCdtb250aCcpLnRvRGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbmREYXRlID0gbW9tZW50KHllYXIgKyAnLScgKyBtb250aCArICctMDEnKS5lbmRPZignbW9udGgnKS50b0RhdGUoKTtcclxuICAgICAgICAgICAgICAgIGxldCBjdXJyZW50TW9tZW50ID0gbW9tZW50KHRoaXMuc3RhcnREYXRlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlzcGxheU5leHRNb250aCA9IGN1cnJlbnRNb21lbnQueWVhcigpIDwgdGhpcy5jdXJyZW50RGF0ZS5nZXRGdWxsWWVhcigpIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgKHRoaXMuY3VycmVudERhdGUuZ2V0RnVsbFllYXIoKSA9PSBjdXJyZW50TW9tZW50LnllYXIoKSAmJiBjdXJyZW50TW9tZW50Lm1vbnRoKCkgPCB0aGlzLmN1cnJlbnREYXRlLmdldE1vbnRoKCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnaW5pdCcpO1xyXG4gICAgICAgIHRoaXMuX2xvYWRJdGVtcygpO1xyXG4gICAgfVxyXG5cclxuICAgIF9sb2FkSXRlbXMoKSB7XHJcbiAgICAgICAgdGhpcy5tb250aExhYmVsID0gbW9tZW50KHRoaXMuc3RhcnREYXRlKS5mb3JtYXQoJ01NTSwgWVlZWScpO1xyXG4gICAgICAgIHRoaXMuc3BlbnRJdGVtU2VydmljZS5nZXRCeURhdGVSYW5nZSh0aGlzLnN0YXJ0RGF0ZSwgdGhpcy5lbmREYXRlLCB0aGlzLnNvcnRDb2wsIHRoaXMuc29ydERpcilcclxuICAgICAgICAgICAgLnRoZW4oKGl0ZW1zKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShpdGVtcykpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtcyA9IGl0ZW1zO1xyXG4gICAgICAgICAgICAgICAgdGhpcy50b3RhbFN1bSA9ICghIWl0ZW1zICYmIGl0ZW1zLmxlbmd0aCkgPyBpdGVtcy5tYXAoKGl0ZW0pID0+IGl0ZW0uZXhjbHVkZUZyb21TdW0gPyAwIDogaXRlbS5zdW0pLnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4KSA6IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmV4Y2x1ZGVkU3VtID0gKCEhaXRlbXMgJiYgaXRlbXMubGVuZ3RoKSA/IGl0ZW1zLm1hcCgoaXRlbSkgPT4gaXRlbS5leGNsdWRlRnJvbVN1bSA/IGl0ZW0uc3VtIDogMCkucmVkdWNlKChzdW0sIHgpID0+IHN1bSArIHgpIDogMDtcclxuICAgICAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBzaG93UHJldk1vbnRoKCkge1xyXG4gICAgICAgIHRoaXMuc3RhcnREYXRlID0gbW9tZW50KHRoaXMuc3RhcnREYXRlKS5zdWJ0cmFjdCgxLCAnbW9udGgnKS5zdGFydE9mKCdtb250aCcpLnRvRGF0ZSgpO1xyXG4gICAgICAgIHRoaXMuZW5kRGF0ZSA9IG1vbWVudCh0aGlzLmVuZERhdGUpLnN1YnRyYWN0KDEsICdtb250aCcpLmVuZE9mKCdtb250aCcpLnRvRGF0ZSgpO1xyXG4gICAgICAgIGxldCBjdXJyZW50TW9tZW50ID0gbW9tZW50KHRoaXMuc3RhcnREYXRlKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh0aGlzLmN1cnJlbnREYXRlLmdldEZ1bGxZZWFyKCkpLCBKU09OLnN0cmluZ2lmeShjdXJyZW50TW9tZW50LnllYXIoKSkpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHRoaXMuY3VycmVudERhdGUuZ2V0TW9udGgoKSksIEpTT04uc3RyaW5naWZ5KGN1cnJlbnRNb21lbnQubW9udGgoKSkpO1xyXG4gICAgICAgIHRoaXMuZGlzcGxheU5leHRNb250aCA9IGN1cnJlbnRNb21lbnQueWVhcigpIDwgdGhpcy5jdXJyZW50RGF0ZS5nZXRGdWxsWWVhcigpIHx8XHJcbiAgICAgICAgICAgICh0aGlzLmN1cnJlbnREYXRlLmdldEZ1bGxZZWFyKCkgPT0gY3VycmVudE1vbWVudC55ZWFyKCkgJiYgY3VycmVudE1vbWVudC5tb250aCgpIDwgdGhpcy5jdXJyZW50RGF0ZS5nZXRNb250aCgpKTtcclxuICAgICAgICB0aGlzLl9sb2FkSXRlbXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93TmV4dE1vbnRoKCkge1xyXG4gICAgICAgIHRoaXMuc3RhcnREYXRlID0gbW9tZW50KHRoaXMuc3RhcnREYXRlKS5hZGQoMSwgJ21vbnRoJykuc3RhcnRPZignbW9udGgnKS50b0RhdGUoKTtcclxuICAgICAgICB0aGlzLmVuZERhdGUgPSBtb21lbnQodGhpcy5lbmREYXRlKS5hZGQoMSwgJ21vbnRoJykuZW5kT2YoJ21vbnRoJykudG9EYXRlKCk7XHJcbiAgICAgICAgbGV0IGN1cnJlbnRNb21lbnQgPSBtb21lbnQodGhpcy5zdGFydERhdGUpO1xyXG4gICAgICAgIHRoaXMuZGlzcGxheU5leHRNb250aCA9IGN1cnJlbnRNb21lbnQueWVhcigpIDwgdGhpcy5jdXJyZW50RGF0ZS5nZXRGdWxsWWVhcigpIHx8XHJcbiAgICAgICAgICAgICh0aGlzLmN1cnJlbnREYXRlLmdldEZ1bGxZZWFyKCkgPT0gY3VycmVudE1vbWVudC55ZWFyKCkgJiYgY3VycmVudE1vbWVudC5tb250aCgpIDwgdGhpcy5jdXJyZW50RGF0ZS5nZXRNb250aCgpKTtcclxuICAgICAgICB0aGlzLl9sb2FkSXRlbXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBlZGl0SXRlbShpZCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdPcGVuIGVkaXQgZm9ybSBmb3IgaXRlbSB3aXRoIElEOicgKyBpZCk7XHJcbiAgICAgICAgdGhpcy5yb3V0ZXJFeHRlbnNpb25zLm5hdmlnYXRlKFtcIi9zcGVudC1mb3JtXCIsIGlkXSwge30pO1xyXG4gICAgfVxyXG5cclxuICAgIGRlbGV0ZUl0ZW0oaWQpIHtcclxuICAgICAgICBjb25maXJtKHRoaXMuZGVsZXRlQ29uZmlybU9wdGlvbnMpLnRoZW4oKHJlc3VsdDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNwZW50SXRlbVNlcnZpY2UuZGVsZXRlKGlkKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9hZEl0ZW1zKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBfZ2V0U29ydEV4cChvcHRpb24pIHtcclxuICAgICAgICBzd2l0Y2ggKG9wdGlvbikge1xyXG4gICAgICAgICAgICBjYXNlICdOZXcgZmlyc3QnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFsnZGF0ZUFkZGVkJywnREVTQyddO1xyXG4gICAgICAgICAgICBjYXNlICdPbGQgZmlyc3QnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFsnZGF0ZUFkZGVkJywnQVNDJ107XHJcbiAgICAgICAgICAgIGNhc2UgJ0V4cGVuc2l2ZSBmaXJzdCc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gWydzdW0nLCdEZXNjJ107XHJcbiAgICAgICAgICAgIGNhc2UgJ0NoZWFwIGZpcnN0JzpcclxuICAgICAgICAgICAgICAgIHJldHVybiBbJ3N1bScsJ0FTQyddO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFsnZGF0ZUFkZGVkJywnREVTQyddO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIG9wZW5Tb3J0RGlhbG9nKCkge1xyXG4gICAgICAgIGFjdGlvbih0aGlzLnNvcnRPcHRpb25zKS50aGVuKChyZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgbGV0IHNvcnRFeHByZXNzaW9uUGFydHMgPSB0aGlzLl9nZXRTb3J0RXhwKHJlc3VsdCk7XHJcbiAgICAgICAgICAgIHRoaXMuc29ydENvbCA9IHNvcnRFeHByZXNzaW9uUGFydHNbMF07XHJcbiAgICAgICAgICAgIHRoaXMuc29ydERpciA9IHNvcnRFeHByZXNzaW9uUGFydHNbMV07XHJcbiAgICAgICAgICAgIHRoaXMuX2xvYWRJdGVtcygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU2VhcmNoTGF5b3V0TG9hZGVkKGV2ZW50KSB7XHJcbiAgICAgICAgaWYgKGV2ZW50Lm9iamVjdC5hbmRyb2lkKSB7XHJcbiAgICAgICAgICAgIGV2ZW50Lm9iamVjdC5hbmRyb2lkLnNldEZvY3VzYWJsZUluVG91Y2hNb2RlKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvblNlYXJjaEJhckxvYWRlZChldmVudCkge1xyXG4gICAgICAgIGlmIChldmVudC5vYmplY3QuYW5kcm9pZCkge1xyXG4gICAgICAgICAgICBldmVudC5vYmplY3QuYW5kcm9pZC5jbGVhckZvY3VzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19